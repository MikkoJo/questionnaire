dojo.provide("agsjs.layers.GoogleMapsLayer");dojo.declare("agsjs.layers.GoogleMapsLayer",esri.layers.Layer,{constructor:function(a){a=a||{};this.tileInfo=new esri.layers.TileInfo({rows:256,cols:256,dpi:96,origin:{x:-20037508.342787,y:20037508.342787},spatialReference:{wkid:102100},lods:[{level:0,resolution:156543.033928,scale:591657527.591555},{level:1,resolution:78271.5169639999,scale:295828763.795777},{level:2,resolution:39135.7584820001,scale:147914381.897889},{level:3,resolution:19567.8792409999,scale:73957190.948944},{level:4,resolution:9783.93962049996,scale:36978595.474472},{level:5,resolution:4891.96981024998,scale:18489297.737236},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,scale:1128.497176}]});this.opacity=a.opacity||1;this._options=a;this._gmap=null;this.loaded=true},setMapTypeId:function(a){if(this._gmap){this._gmap.setMapTypeId(a)}else{this._options.mapTypeId=a}this._mapTypeChangeHandler()},onMapTypeIdChanged:function(a){},getGMap:function(){return this._gmap},_setMap:function(i,h,f,e,d,k){this._map=i;var j=dojo.create("div",null,h);if(this._options.id){j.id=this.id}var g={position:"absolute",top:"0px",left:"0px",width:(i.width||h.offsetWidth)+"px",height:(i.height||h.offsetHeight)+"px"};dojo.style(j,g);this._div=j;this._visibilityChangeHandle=dojo.connect(this,"onVisibilityChange",this,this._visibilityChangeHandler);this._opacityChangeHandle=dojo.connect(this,"onOpacityChange",this,this._onOpacityChangeHandler);this.visible=(this._options.visible===undefined)?true:this._options.visible;if(this.visible){this._initGMap()}return j},_unsetMap:function(b,a){if(a){a.removeChild(this._div)}dojo.destroy(this._div);this._map=null;this._div=null;this._gmap=null;dojo.disconnect(this._extentChangeHandle);dojo.disconnect(this._panHandle);dojo.disconnect(this._resizeHandle);dojo.disconnect(this._visibilityChangeHandle);dojo.disconnect(this._opacityChangeHandle);dojo.disconnect(this._gmapTypeChangeHandle)},_initGMap:function(){if(window.google&&google.maps){var f=[{featureType:"landscape",elementType:"labels",stylers:[{visibility:"off"}]}];var d=this._map.extent;var a=this._options.center||this._esriPointToLatLng(d.getCenter());var h=this._map.getLevel();var b={mapTypeId:this._options.mapTypeId||google.maps.MapTypeId.ROADMAP,disableDefaultUI:true,center:a,zoom:this._options.zoom||(h>-1)?h:1,panControl:false,streetViewControl:false,styles:f,zoomControl:false};var e=new google.maps.Map(this._div,b);if(h<1){e.fitBounds(this._esriExtentToLatLngBounds(d))}this._gmap=e;this._extentChangeHandle=dojo.connect(this._map,"onExtentChange",this,this._extentChangeHandler);this._panHandle=dojo.connect(this._map,"onPan",this,this._panHandler);this._resizeHandle=dojo.connect(this._map,"onResize",this,this._resizeHandler);this._gmapTypeChangeHandle=google.maps.event.addListener(this._gmap,"maptypeid_changed",dojo.hitch(this,this._mapTypeChangeHandler));this.onLoad(this)}else{if(agsjs.onGMapsApiLoad){dojo.connect(agsjs,"onGMapsApiLoad",this,this._initGMap)}else{agsjs.onGMapsApiLoad=function(){};dojo.connect(agsjs,"onGMapsApiLoad",this,this._initGMap);var c=document.createElement("script");c.type="text/javascript";var g=window.location.protocol+"//maps.google.com/maps/api/js?sensor="+(this._options.sensor?"true":"false");if(this._options.client){g+="&client="+this._options.client}if(this._options.version){g+="&v"+this._options.version}g+="&callback=agsjs.onGMapsApiLoad";c.src=g;if(document.getElementsByTagName("head").length>0){document.getElementsByTagName("head")[0].appendChild(c)}else{document.body.appendChild(c)}}}},_opacityChangeHandler:function(a){this.setOpacity(a)},setOpacity:function(b){if(this._div){b=Math.min(Math.max(b,0),1);var a=this._div.style;if(typeof a.opacity!=="undefined"){a.opacity=b}else{if(typeof a.filters!=="undefined"){a.filters.alpha.opacity=Math.floor(100*b)}else{if(typeof a.filter!=="undefined"){a.filter="alpha(opacity:"+Math.floor(b*100)+")"}}}}this.opacity=b},_visibilityChangeHandler:function(a){if(a){esri.show(this._div);this.visible=true;if(this._gmap){google.maps.event.trigger(this._gmap,"resize");this._panHandle=this._panHandle||dojo.connect(this._map,"onPan",this,"_panHandler");this._extentChangeHandle=this._extentChangeHandle||dojo.connect(this._map,"onExtentChange",this,"_extentChangeHandler");this._setExtent(this._map.extent)}else{this._initGMap()}}else{if(this._div){esri.hide(this._div);this.visible=false;if(this._panHandle){dojo.disconnect(this._panHandle);this._panHandle=null}if(this._extentChangeHandle){dojo.disconnect(this._extentChangeHandle);this._extentChangeHandle=null}}}},_resizeHandler:function(c,a,b){dojo.style(this._div,{width:this._map.width+"px",height:this._map.height+"px"});google.maps.event.trigger(this._gmap,"resize")},_extentChangeHandler:function(a,d,c,b){if(c){this._setExtent(a)}else{if(d.x!==0||d.y!==0){this._gmap.setCenter(this._esriPointToLatLng(a.getCenter()))}}},_panHandler:function(a,b){if(b.x!==0||b.y!==0){this._gmap.setCenter(this._esriPointToLatLng(a.getCenter()))}},_mapTypeChangeHandler:function(){this._checkZoomLevel();this.onMapTypeIdChanged(this._gmap.getMapTypeId())},_checkZoomLevel:function(){var g=this._gmap.getMapTypeId();var c=this._gmap.mapTypes;var f=null;for(var a in c){if(c.hasOwnProperty(a)&&a==g){f=c[a];break}}if(f!=null){var b=f.minZoom;var e=f.maxZoom;var d=this._map.getLevel();if(e!==undefined&&d>e){this._map.setLevel(e)}if(b!=undefined&&d<b){this._map.setLevel(b)}}},_setExtent:function(b){var c=this._map.getLevel();if(c>=0){var a=this._esriPointToLatLng(b.getCenter());this._gmap.setZoom(c);this._gmap.setCenter(a);this._checkZoomLevel()}else{this._gmap.fitBounds(this._esriExtentToLatLngBounds(b))}},_esriPointToLatLng:function(b){var a=esri.geometry.webMercatorToGeographic(b);return new google.maps.LatLng(a.y,a.x)},_esriExtentToLatLngBounds:function(b){var a=esri.geometry.webMercatorToGeographic(b);return new google.maps.LatLngBounds(new google.maps.LatLng(a.ymin,a.xmin,true),new google.maps.LatLng(a.ymax,a.xmax,true))}});